<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faith Defenders - Security Monitoring Dashboard</title>
    <link rel="stylesheet" href="static/style.css">
    <style>
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .dashboard-status {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
        }

        .status-indicator.loading {
            background: #ffc107;
            animation: pulse 1s infinite;
        }

        .status-indicator.error {
            background: #dc3545;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #1e3c72;
        }

        .metric-card.success { border-left-color: #28a745; }
        .metric-card.warning { border-left-color: #ffc107; }
        .metric-card.danger { border-left-color: #dc3545; }
        .metric-card.info { border-left-color: #17a2b8; }

        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .metric-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .alerts-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .alert-item {
            padding: 15px;
            border-left: 4px solid #ffc107;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .alert-item.critical { border-left-color: #dc3545; background: #f8d7da; }
        .alert-item.warning { border-left-color: #ffc107; background: #fff3cd; }
        .alert-item.info { border-left-color: #17a2b8; background: #d1ecf1; }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .logs-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .log-entry {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-family: monospace;
            font-size: 0.9em;
        }

        .log-entry.error { color: #dc3545; }
        .log-entry.warning { color: #856404; }
        .log-entry.info { color: #0c5460; }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background: #28a745; }
        .status-warning { background: #ffc107; }
        .status-offline { background: #dc3545; }

        .refresh-btn {
            background: #1e3c72;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            background: #2a5298;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            border-bottom-color: #1e3c72;
            color: #1e3c72;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .admin-sessions {
            max-height: 400px;
            overflow-y: auto;
        }

        .session-item {
            padding: 10px;
            border: 1px solid #dee2e6;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .session-item.active {
            border-color: #28a745;
            background: #d4edda;
        }

        .threat-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .threat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .threat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #dc3545;
        }

        /* Profile Section Styles */
        .profile-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
        }

        .user-avatar {
            margin-right: 20px;
        }

        .user-avatar img {
            border-radius: 50%;
            border: 3px solid #1e3c72;
            width: 100px;
            height: 100px;
        }

        .user-details h4 {
            margin: 0 0 10px 0;
            color: #1e3c72;
            font-size: 1.5em;
        }

        .user-details p {
            margin: 5px 0;
            color: #666;
        }

        .user-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .recent-activity {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .recent-activity h4 {
            margin-top: 0;
            color: #1e3c72;
        }

        .activity-item {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
            font-size: 0.9em;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 10px;
            }

            .metrics-grid, .charts-container, .threat-indicators, .user-metrics {
                grid-template-columns: 1fr;
            }

            .user-info {
                flex-direction: column;
                text-align: center;
            }

            .user-avatar {
                margin-right: 0;
                margin-bottom: 15px;
            }
        }

        /* Animations */
        .tab-content {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .metric-card:hover {
            transform: translateY(-5px);
            transition: transform 0.2s ease;
        }

        .alert-item, .activity-item {
            transition: background-color 0.2s ease;
        }

        .alert-item:hover, .activity-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>üõ°Ô∏è Faith Defenders Security Monitoring Dashboard</h1>
            <p>Real-time security monitoring and threat detection</p>
            <button class="refresh-btn" onclick="refreshDashboard()">üîÑ Refresh Dashboard</button>
            <div class="dashboard-status" id="dashboard-status">
                <div class="status-indicator loading" id="status-indicator"></div>
                <span id="status-message">Loading security data...</span>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('overview')">Overview</div>
            <div class="tab" onclick="switchTab('threats')">Threat Detection</div>
            <div class="tab" onclick="switchTab('profile')">My Profile</div>
            <div class="tab" onclick="switchTab('logs')">Security Logs</div>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <!-- Security Metrics -->
            <div class="metrics-grid">
                <div class="metric-card success">
                    <div class="metric-label">Active Sessions</div>
                    <div class="metric-value" id="active-sessions">0</div>
                    <div>Currently authenticated users</div>
                </div>

                <div class="metric-card info">
                    <div class="metric-label">Total Requests (24h)</div>
                    <div class="metric-value" id="total-requests">0</div>
                    <div>API requests in last 24 hours</div>
                </div>

                <div class="metric-card warning">
                    <div class="metric-label">Blocked Requests</div>
                    <div class="metric-value" id="blocked-requests">0</div>
                    <div>Requests blocked by security</div>
                </div>

                <div class="metric-card danger">
                    <div class="metric-label">Security Alerts</div>
                    <div class="metric-value" id="security-alerts">0</div>
                    <div>Active security alerts</div>
                </div>

                <div class="metric-card info">
                    <div class="metric-label">Rate Limit Hits</div>
                    <div class="metric-value" id="rate-limit-hits">0</div>
                    <div>Rate limit violations</div>
                </div>

                <div class="metric-card success">
                    <div class="metric-label">Uptime</div>
                    <div class="metric-value" id="uptime">100%</div>
                    <div>System availability</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-container">
                <div class="chart-card">
                    <h3>Request Activity (Last 24h)</h3>
                    <canvas id="activity-chart" width="400" height="200"></canvas>
                </div>

                <div class="chart-card">
                    <h3>Security Events Distribution</h3>
                    <canvas id="security-chart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Recent Alerts -->
            <div class="alerts-section">
                <h3>Recent Security Alerts</h3>
                <div id="alerts-container">
                    <div class="alert-item info">
                        <strong>System Status:</strong> All security systems operational
                    </div>
                </div>
            </div>
        </div>

        <!-- Threat Detection Tab -->
        <div id="threats" class="tab-content">
            <div class="threat-indicators">
                <div class="threat-card">
                    <h4>Brute Force Attempts</h4>
                    <div class="threat-value" id="brute-force-count">0</div>
                    <small>Last 24 hours</small>
                </div>

                <div class="threat-card">
                    <h4>Suspicious IPs</h4>
                    <div class="threat-value" id="suspicious-ips">0</div>
                    <small>Currently blocked</small>
                </div>

                <div class="threat-card">
                    <h4>CSRF Attempts</h4>
                    <div class="threat-value" id="csrf-attempts">0</div>
                    <small>Last 24 hours</small>
                </div>

                <div class="threat-card">
                    <h4>SQL Injection Attempts</h4>
                    <div class="threat-value" id="sql-injection">0</div>
                    <small>Last 24 hours</small>
                </div>
            </div>

            <div class="chart-card" style="margin-top: 20px;">
                <h3>Threat Activity Timeline</h3>
                <canvas id="threat-chart" width="800" height="300"></canvas>
            </div>
        </div>

        <!-- My Profile Tab -->
        <div id="profile" class="tab-content">
            <div class="profile-section">
                <h3>Your Profile</h3>
                <div class="user-info">
                    <div class="user-avatar">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNDAiIHI9IjIwIiBmaWxsPSIjMWUzYzcyIiBzdHJva2U9IiMyYTUyOTgiIHN0cm9rZS13aWR0aD0iMiIvPjxwYXRoIGQ9Ik0zMCA2MWMwIDYtNS41IDEwLTEyIDEwcy0xMi00LTEyLTEwIiBmaWxsPSIjMWUzYzcyIi8+PHBhdGggZD0iTTMwIDYwYzAgNi01LjUgMTAtMTIgMTBzLTEyLTQtMTItMTBMMzAgNjB6IiBmaWxsPSIjMmE1Mjk4Ii8+PC9zdmc+" alt="User Avatar" id="user-avatar">
                    </div>
                    <div class="user-details">
                        <h4 id="user-name">Loading...</h4>
                        <p id="user-email">Loading...</p>
                        <p><strong>Last Login:</strong> <span id="last-login">Loading...</span></p>
                        <p><strong>Account Status:</strong> <span id="account-status">Active</span></p>
                    </div>
                </div>
                <div class="user-metrics">
                    <div class="metric-card success">
                        <div class="metric-label">Your Login Attempts (24h)</div>
                        <div class="metric-value" id="user-login-attempts">0</div>
                    </div>
                    <div class="metric-card warning">
                        <div class="metric-label">Your Blocked Requests</div>
                        <div class="metric-value" id="user-blocked-requests">0</div>
                    </div>
                    <div class="metric-card info">
                        <div class="metric-label">Your Alerts</div>
                        <div class="metric-value" id="user-alerts">0</div>
                    </div>
                </div>
                <div class="recent-activity">
                    <h4>Recent Activity</h4>
                    <div id="user-activity">
                        <div class="activity-item">Logged in from IP 192.168.1.1</div>
                        <div class="activity-item">Password changed</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Logs Tab -->
        <div id="logs" class="tab-content">
            <div class="logs-section">
                <h3>Security Event Logs</h3>
                <div id="logs-container">
                    <div class="log-entry info">[INFO] Security dashboard initialized</div>
                    <div class="log-entry info">[INFO] All security systems operational</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Security Dashboard Controller
        class SecurityDashboard {
            constructor() {
                this.charts = {};
                this.updateInterval = null;
                this.init();
            }

            init() {
                this.showLoadingState();
                this.initializeCharts();
                this.loadDashboardData();
                this.startAutoRefresh();
            }

            initializeCharts() {
                // Activity Chart - initialize with empty data
                const activityCtx = document.getElementById('activity-chart').getContext('2d');
                this.charts.activity = new Chart(activityCtx, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: 'Requests',
                            data: Array.from({length: 24}, () => 0),
                            borderColor: '#1e3c72',
                            backgroundColor: 'rgba(30, 60, 114, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });

                // Security Events Chart
                const securityCtx = document.getElementById('security-chart').getContext('2d');
                this.charts.security = new Chart(securityCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Normal', 'Warnings', 'Critical'],
                        datasets: [{
                            data: [0, 0, 0],
                            backgroundColor: ['#28a745', '#ffc107', '#dc3545']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });

                // Threat Chart
                const threatCtx = document.getElementById('threat-chart').getContext('2d');
                this.charts.threat = new Chart(threatCtx, {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: 7}, (_, i) => `Day ${i + 1}`),
                        datasets: [{
                            label: 'Threats Detected',
                            data: Array.from({length: 7}, () => 0),
                            backgroundColor: '#dc3545'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            updateCharts(data) {
                // Update activity chart with real data (simulate hourly data distribution)
                if (this.charts.activity) {
                    const totalRequests = data.metrics.totalRequests || 0;
                    // Distribute total requests across 24 hours with some variation
                    const hourlyData = Array.from({length: 24}, (_, i) => {
                        const baseValue = totalRequests / 24;
                        const variation = (Math.random() - 0.5) * baseValue * 0.4; // +/- 40% variation
                        return Math.max(0, Math.floor(baseValue + variation));
                    });

                    this.charts.activity.data.datasets[0].data = hourlyData;
                    this.charts.activity.update();
                }

                // Update security events distribution
                if (this.charts.security && data.logs) {
                    const infoCount = data.logs.filter(log => log.level === 'info').length;
                    const warningCount = data.logs.filter(log => log.level === 'warning').length;
                    const criticalCount = data.logs.filter(log => log.level === 'error' || log.level === 'critical').length;

                    this.charts.security.data.datasets[0].data = [infoCount, warningCount, criticalCount];
                    this.charts.security.update();
                }

                // Update threat chart with real data
                if (this.charts.threat) {
                    // Simulate 7-day threat data based on current threat stats
                    const totalThreats = (data.threats.bruteForce || 0) +
                                       (data.threats.csrfAttempts || 0) +
                                       (data.threats.sqlInjection || 0);

                    // Distribute threats across days with decreasing trend
                    const threatData = Array.from({length: 7}, (_, i) => {
                        const daysFromNow = 6 - i; // 0 = today, 6 = 7 days ago
                        const decayFactor = Math.pow(0.8, daysFromNow); // Exponential decay
                        return Math.floor(totalThreats * 0.1 * decayFactor + Math.random() * 5);
                    });

                    this.charts.threat.data.datasets[0].data = threatData;
                    this.charts.threat.update();
                }
            }

            async loadDashboardData() {
                try {
                    console.log('Loading dashboard data...');
                    // Simulate API calls to get security data
                    const securityData = await this.fetchSecurityData();

                    if (!securityData) {
                        // If no data was returned (e.g., due to auth issues), show fallback data
                        console.warn('No security data received, showing fallback data');
                        const fallbackData = {
                            metrics: {
                                activeSessions: 0,
                                totalRequests: 0,
                                blockedRequests: 0,
                                securityAlerts: 0,
                                rateLimitHits: 0,
                                uptime: 'N/A'
                            },
                            alerts: [],
                            logs: [],
                            threats: { bruteForce: 0, suspiciousIPs: 0, csrfAttempts: 0, sqlInjection: 0 },
                            user: {
                                name: 'Administrator',
                                email: 'admin@example.com',
                                lastLogin: new Date().toISOString(),
                                loginAttempts: 0,
                                blockedRequests: 0,
                                alerts: 0,
                                activity: ['Dashboard accessed', 'Security monitoring active']
                            }
                        };
                        this.updateDashboard(fallbackData);
                        this.updateStatus(false);
                        return;
                    }

                    // Update metrics
                    this.updateMetrics(securityData);

                    // Update charts with real data
                    this.updateCharts(securityData);

                    // Update alerts
                    this.updateAlerts(securityData.alerts);

                    // Update logs
                    this.updateLogs(securityData.logs);

                    // Update profile with user data or fallback
                    const userData = (securityData && securityData.user) ? securityData.user : {
                        name: 'Administrator',
                        email: 'admin@example.com',
                        lastLogin: new Date().toISOString(),
                        loginAttempts: 0,
                        blockedRequests: 0,
                        alerts: 0,
                        activity: ['Dashboard accessed', 'Security monitoring active']
                    };
                    this.updateProfile({ user: userData });

                    // Update user activity (with null checking)
                    if (securityData && securityData.user && Array.isArray(securityData.user.activity)) {
                        this.updateUserActivity(securityData.user.activity);
                    } else {
                        this.updateUserActivity(['Dashboard accessed', 'Security monitoring active']);
                    }

                    this.updateStatus(false);
                } catch (error) {
                    console.error('Failed to load dashboard data:', error);
                    this.updateStatus(false, true);
                    this.showError('Failed to load security data. Please check your connection and try again.');
                }
            }

            async fetchSecurityData() {
                try {
                    // Fetch data from admin API endpoints
                    const [dashboardResponse, alertsResponse, eventsResponse, threatsResponse] = await Promise.all([
                        fetch('/api/admin/security/dashboard', {
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json' }
                        }),
                        fetch('/api/admin/security/alerts?status=active&limit=10', {
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json' }
                        }),
                        fetch('/api/admin/security/events?limit=50', {
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json' }
                        }),
                        fetch('/api/admin/security/threats', {
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json' }
                        })
                    ]);

                    // Check for authentication errors
                    if (dashboardResponse.status === 403) {
                        throw new Error('Admin access required');
                    }

                    if (!dashboardResponse.ok) {
                        throw new Error(`Dashboard API error! status: ${dashboardResponse.status}`);
                    }

                    const [dashboardData, alertsData, eventsData, threatsData] = await Promise.all([
                        dashboardResponse.json(),
                        alertsResponse.ok ? alertsResponse.json() : { alerts: [] },
                        eventsResponse.ok ? eventsResponse.json() : { events: [] },
                        threatsResponse.ok ? threatsResponse.json() : { threatMetrics: { types: [] }, rateLimitStats: {} }
                    ]);

                    // Transform data to match expected format
                    return {
                        metrics: dashboardData.metrics || {
                            activeSessions: 0,
                            totalRequests: 0,
                            blockedRequests: 0,
                            securityAlerts: 0,
                            rateLimitHits: 0,
                            uptime: 'N/A'
                        },
                        alerts: (alertsData.alerts || []).map(alert => ({
                            type: alert.severity === 'critical' ? 'critical' :
                                  alert.severity === 'high' ? 'danger' :
                                  alert.severity === 'medium' ? 'warning' : 'info',
                            message: alert.message,
                            timestamp: alert.last_seen || alert.first_seen,
                            severity: alert.severity
                        })),
                        logs: (eventsData.events || []).map(event => ({
                            level: event.level,
                            message: `${event.event_type}: ${event.message}`,
                            timestamp: event.timestamp
                        })),
                        threats: {
                            bruteForce: threatsData.threatMetrics?.types?.find(t => t.type === 'brute_force')?.count || 0,
                            suspiciousIPs: threatsData.threatMetrics?.blocked || 0,
                            csrfAttempts: threatsData.threatMetrics?.types?.find(t => t.type === 'csrf')?.count || 0,
                            sqlInjection: threatsData.threatMetrics?.types?.find(t => t.type === 'sql_injection')?.count || 0
                        },
                        user: {
                            name: 'Administrator',
                            email: 'admin@example.com',
                            lastLogin: new Date().toISOString(),
                            loginAttempts: 0,
                            blockedRequests: 0,
                            alerts: 0,
                            activity: ['Dashboard accessed', 'Security monitoring active']
                        }
                    };
                } catch (error) {
                    console.error('Failed to fetch security data:', error);
                    if (error.message === 'Admin access required') {
                        this.showUnauthorized();
                        return null;
                    }
                    throw error;
                }
            }

            updateMetrics(data) {
                document.getElementById('active-sessions').textContent = data.metrics.activeSessions;
                document.getElementById('total-requests').textContent = data.metrics.totalRequests.toLocaleString();
                document.getElementById('blocked-requests').textContent = data.metrics.blockedRequests;
                document.getElementById('security-alerts').textContent = data.metrics.securityAlerts;
                document.getElementById('rate-limit-hits').textContent = data.metrics.rateLimitHits;
                document.getElementById('uptime').textContent = data.metrics.uptime;

                // Update threat indicators
                document.getElementById('brute-force-count').textContent = data.threats.bruteForce;
                document.getElementById('suspicious-ips').textContent = data.threats.suspiciousIPs;
                document.getElementById('csrf-attempts').textContent = data.threats.csrfAttempts;
                document.getElementById('sql-injection').textContent = data.threats.sqlInjection;
            }

            updateAlerts(alerts) {
                const container = document.getElementById('alerts-container');
                container.innerHTML = '';

                alerts.forEach(alert => {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = `alert-item ${alert.type}`;
                    alertDiv.innerHTML = `
                        <strong>${alert.type.toUpperCase()}:</strong> ${alert.message}
                        <br><small>${new Date(alert.timestamp).toLocaleString()}</small>
                    `;
                    container.appendChild(alertDiv);
                });
            }

            updateLogs(logs) {
                const container = document.getElementById('logs-container');
                container.innerHTML = '';

                logs.forEach(log => {
                    const logDiv = document.createElement('div');
                    logDiv.className = `log-entry ${log.level}`;
                    logDiv.innerHTML = `[${new Date(log.timestamp).toLocaleString()}] ${log.message}`;
                    container.appendChild(logDiv);
                });
            }

            updateProfile(data) {
                try {
                    // Ensure data exists and has proper structure
                    if (!data) {
                        console.warn('No data provided to updateProfile, using fallback');
                        data = {
                            user: {
                                name: 'Administrator',
                                email: 'admin@example.com',
                                lastLogin: new Date().toISOString(),
                                loginAttempts: 0,
                                blockedRequests: 0,
                                alerts: 0,
                                avatar: null,
                                activity: ['Dashboard accessed', 'Security monitoring active']
                            }
                        };
                    }

                    // Ensure user object exists with fallbacks
                    var userData = (data && data.user) ? data.user : {
                        name: 'Administrator',
                        email: 'admin@example.com',
                        lastLogin: new Date().toISOString(),
                        loginAttempts: 0,
                        blockedRequests: 0,
                        alerts: 0,
                        avatar: null,
                        activity: ['Dashboard accessed', 'Security monitoring active']
                    };

                    // Additional safety check - ensure userData is a valid object
                    if (!userData || typeof userData !== 'object') {
                        console.warn('Invalid userData, using emergency fallback');
                        var emergencyUserData = {
                            name: 'Administrator',
                            email: 'admin@example.com',
                            lastLogin: new Date().toISOString(),
                            loginAttempts: 0,
                            blockedRequests: 0,
                            alerts: 0,
                            avatar: null,
                            activity: ['Dashboard accessed', 'Security monitoring active']
                        };
                        this.updateProfileElements(emergencyUserData);
                        return;
                    }

                    // Update profile elements with validated data
                    this.updateProfileElements(userData);
                } catch (error) {
                    console.error('Error updating profile:', error);
                    // Emergency fallback
                    var emergencyUserData = {
                        name: 'Administrator',
                        email: 'admin@example.com',
                        lastLogin: new Date().toISOString(),
                        loginAttempts: 0,
                        blockedRequests: 0,
                        alerts: 0,
                        avatar: null,
                        activity: ['Dashboard accessed', 'Security monitoring active']
                    };
                    this.updateProfileElements(emergencyUserData);
                }
            }

            updateProfileElements(userData) {
                try {
                    // Safely update user name with fallback
                    var userName = userData.name || 'Administrator';
                    var userNameElement = document.getElementById('user-name');
                    if (userNameElement) {
                        userNameElement.textContent = userName;
                    }

                    // Safely update user email with fallback
                    var userEmail = userData.email || 'admin@example.com';
                    var userEmailElement = document.getElementById('user-email');
                    if (userEmailElement) {
                        userEmailElement.textContent = userEmail;
                    }

                    // Safely update last login with fallback
                    var lastLogin = userData.lastLogin ?
                        new Date(userData.lastLogin).toLocaleString() :
                        new Date().toLocaleString();
                    var lastLoginElement = document.getElementById('last-login');
                    if (lastLoginElement) {
                        lastLoginElement.textContent = lastLogin;
                    }

                    // Safely update other user metrics with fallbacks
                    var loginAttempts = userData.loginAttempts || 0;
                    var loginAttemptsElement = document.getElementById('user-login-attempts');
                    if (loginAttemptsElement) {
                        loginAttemptsElement.textContent = loginAttempts.toString();
                    }

                    var blockedRequests = userData.blockedRequests || 0;
                    var blockedRequestsElement = document.getElementById('user-blocked-requests');
                    if (blockedRequestsElement) {
                        blockedRequestsElement.textContent = blockedRequests.toString();
                    }

                    var userAlerts = userData.alerts || 0;
                    var userAlertsElement = document.getElementById('user-alerts');
                    if (userAlertsElement) {
                        userAlertsElement.textContent = userAlerts.toString();
                    }

                    // Update user avatar with a working fallback SVG
                    var userAvatar = document.getElementById('user-avatar');
                    if (userAvatar) {
                        var avatarSrc = userData.avatar || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNDAiIHI9IjIwIiBmaWxsPSIjMWUzYzcyIiBzdHJva2U9IiMyYTUyOTgiIHN0cm9rZS13aWR0aD0iMiIvPjxwYXRoIGQ9Ik0zMCA2MWMwIDYtNS41IDEwLTEyIDEwcy0xMi00LTEyLTEwIiBmaWxsPSIjMWUzYzcyIi8+PHBhdGggZD0iTTMwIDYwYzAgNi01LjUgMTAtMTIgMTBzLTEyLTQtMTItMTBMMzAgNjB6IiBmaWxsPSIjMmE1Mjk4Ii8+PC9zdmc+';
                        userAvatar.src = avatarSrc;
                        userAvatar.onerror = function() {
                            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNDAiIHI9IjIwIiBmaWxsPSIjMWUzYzcyIiBzdHJva2U9IiMyYTUyOTgiIHN0cm9rZS13aWR0aD0iMiIvPjxwYXRoIGQ9Ik0zMCA2MWMwIDYtNS41IDEwLTEyIDEwcy0xMi00LTEyLTEwIiBmaWxsPSIjMWUzYzcyIi8+PHBhdGggZD0iTTMwIDYwYzAgNi01LjUgMTAtMTIgMTBzLTEyLTQtMTItMTBMMzAgNjB6IiBmaWxsPSIjMmE1Mjk4Ii8+PC9zdmc+';
                        };
                    }
                } catch (error) {
                    console.error('Error updating profile elements:', error);
                    // Final fallback: set basic profile info
                    var userNameElement = document.getElementById('user-name');
                    if (userNameElement) userNameElement.textContent = 'Administrator';
                    var userEmailElement = document.getElementById('user-email');
                    if (userEmailElement) userEmailElement.textContent = 'admin@example.com';
                }
            }

            updateUserActivity(activity) {
                const container = document.getElementById('user-activity');
                container.innerHTML = '';

                activity.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'activity-item';
                    div.textContent = item;
                    container.appendChild(div);
                });
            }

            startAutoRefresh() {
                this.updateInterval = setInterval(() => {
                    this.loadDashboardData();
                }, 30000); // Refresh every 30 seconds
            }

            stopAutoRefresh() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                    this.updateInterval = null;
                }
            }

    showLoadingState() {
        // Update status indicator
        const statusIndicator = document.getElementById('status-indicator');
        const statusMessage = document.getElementById('status-message');
        if (statusIndicator && statusMessage) {
            statusIndicator.className = 'status-indicator loading';
            statusMessage.textContent = 'Loading security data...';
        }

        // Show loading messages in the UI
        document.getElementById('active-sessions').textContent = 'Loading...';
        document.getElementById('total-requests').textContent = 'Loading...';
        document.getElementById('blocked-requests').textContent = 'Loading...';
        document.getElementById('security-alerts').textContent = 'Loading...';
        document.getElementById('rate-limit-hits').textContent = 'Loading...';
        document.getElementById('uptime').textContent = 'Loading...';

        // Show loading text in threat cards
        document.getElementById('brute-force-count').textContent = 'Loading...';
        document.getElementById('suspicious-ips').textContent = 'Loading...';
        document.getElementById('csrf-attempts').textContent = 'Loading...';
        document.getElementById('sql-injection').textContent = 'Loading...';

        // Show loading message in alerts section
        const alertsContainer = document.getElementById('alerts-container');
        alertsContainer.innerHTML = '<div class="alert-item info"><strong>STATUS:</strong> Loading security data...</div>';

        // Show loading message in logs section
        const logsContainer = document.getElementById('logs-container');
        logsContainer.innerHTML = '<div class="log-entry info">[INFO] Connecting to security database...</div>';
    }

    updateDashboard(data) {
        // Update metrics
        this.updateMetrics(data);

        // Update charts with data
        this.updateCharts(data);

        // Update alerts
        this.updateAlerts(data.alerts || []);

        // Update logs
        this.updateLogs(data.logs || []);

        // Update profile with proper data structure
        this.updateProfile({ user: data.user });

        // Update user activity
        this.updateUserActivity(data.user?.activity || ['Dashboard accessed', 'Security monitoring active']);
    }

    updateStatus(loading = false, error = false) {
        const statusIndicator = document.getElementById('status-indicator');
        const statusMessage = document.getElementById('status-message');

        if (statusIndicator && statusMessage) {
            if (error) {
                statusIndicator.className = 'status-indicator error';
                statusMessage.textContent = 'Failed to load data - will retry...';
            } else if (loading) {
                statusIndicator.className = 'status-indicator loading';
                statusMessage.textContent = 'Refreshing security data...';
            } else {
                statusIndicator.className = 'status-indicator';
                statusMessage.textContent = `Updated ${new Date().toLocaleTimeString()}`;
            }
        }
    }

            showError(message) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert-item danger';
                alertDiv.innerHTML = `<strong>ERROR:</strong> ${message}`;
                document.getElementById('alerts-container').prepend(alertDiv);

                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            }

            showUnauthorized() {
                document.body.innerHTML = `
                    <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
                        <h1 style="color: #dc3545;">Access Denied</h1>
                        <p>Administrator access required to view this dashboard.</p>
                        <a href="/" style="color: #1e3c72; text-decoration: none;">Return to Home</a>
                    </div>
                `;
            }
        }

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName).classList.add('active');

            // Add active class to selected tab
            event.target.classList.add('active');
        }

        // Refresh dashboard function
        function refreshDashboard() {
            if (window.dashboard) {
                window.dashboard.loadDashboardData();
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboard = new SecurityDashboard();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (window.dashboard) {
                window.dashboard.stopAutoRefresh();
            }
        });
    </script>
</body>
</html>
